{% extends "layout.html" %}
{% block content %}
<h2 style="font-size: 2.5rem; margin-bottom: 2rem;">ðŸŽ¬ Popular Movies</h2>

<div style="display: flex; flex-wrap: wrap; gap: 2rem;">
    {% for movie in movies %}
    <div style="
        width: calc(50% - 1rem);
        border-bottom: 1px solid #ddd;
        padding-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        font-size: 1.2rem;
    ">
        <a href="{{ url_for('movie_detail', movie_id=movie.id) }}" style="text-decoration: none; color: #2c3e50;">
            <strong style="font-size: 1.6rem;">{{ movie.title }}</strong>
        </a>
        <div style="color: #888; font-size: 1rem; margin-top: 0.4rem;">
            {{ movie.release_date }}
        </div>
        <p style="margin-top: 0.6rem;">
            {{ movie.overview|length > 150 and movie.overview[:150] ~ '...' or movie.overview }}
        </p>
        {% if movie.poster_path %}
        <img
            src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}"
            alt="{{ movie.title }} poster"
            style="margin: 0.75rem 0; border-radius: 10px; width: 100%; max-width: 300px;">
        {% endif %}
        <button
            onclick="addFavorite({{ movie.id }})"
            style="
                padding: 0.8rem 1.4rem;
                background-color: #e74c3c;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                width: fit-content;
            ">
            Add to Favorites
        </button>
    </div>
    {% endfor %}
</div>

<script>
function addFavorite(movieId) {
    firebase.auth().currentUser.getIdToken(true)
      .then(function(idToken) {
        fetch(`/favorite/${movieId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + idToken
          }
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message || data.error || "Movie added to favorites!");
        })
        .catch(err => {
          console.error(err);
          alert("Something went wrong. Try again!");
        });
      })
      .catch(function(error) {
        alert("Please sign in to add favorites!");
      });
}
</script>
{% endblock %}
